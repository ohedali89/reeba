
function sc_pb_app_process(scjQuery){
  
		var APP_BASE_URL = '/apps/product-badge';
		var MSG_TYPE_NOTICE = 'notice';
		//

 
  		
  SCPB.get_page_products=function(callback){
          var char_limit=170;
          var search_queries=[];
          var handles=[];
          var str_handles='';
          var sc_ws_collection_products={
              total_products:0,
              products:[],
              products_by_handle:{},
              products_by_id:{}
          };
          scjQuery('a[href*="/products/"]').each(function(idx){
              var url=scjQuery(this).attr('href');
              var handle=SCPB.get_product_handle(url);
              //var handle=url.replace('/products/','');

              if(handles.indexOf(handle)==-1){
                  handles.push(handle);
              }
          });

          var counter=0;
          for(i=0;i<handles.length;i++){
              var handle=handles[i];

              counter+=handle.length+14;
              if(counter >= char_limit){
                  search_queries.push(str_handles);
                  counter=0;
                  str_handles='';
              }
              if(str_handles.length > 0){
                str_handles += " OR ";
              }                
              str_handles += "handle:\"" + handle + "\"";
          }
          search_queries.push(str_handles);


          var q_done_count=0;
          var i=0;
          for(i=0;i<search_queries.length;i++){
              scjQuery.ajax({
                url : '/search?type=product&view=sc-pb-front-25052016&q='+search_queries[i],
                processData : false,
                contentType : false,
                //dataType : 'json',
                success : function(product_data, textStatus, jqXHR){
                    
                  	product_data=JSON.parse(product_data);
                    var products=product_data.Items;
					//console.log(products);
                    for(j=0;j<products.length;j++){
                        sc_ws_collection_products.products.push(products[j]);
                        sc_ws_collection_products.products_by_handle[products[j].handle]=products[j];
                        sc_ws_collection_products.products_by_id[products[j].id]=products[j];
                    }
                    sc_ws_collection_products.total_products+=product_data.TotalProduct;
                    q_done_count+=1;

                    if(q_done_count==search_queries.length){
                        callback(sc_ws_collection_products);
                    }

                }
            });
          }


      };
  
      SCPB.get_product_handle=function(url){
          url=url.trim();
          if(url.endsWith('/')){
              url=url.substr(0,(url.length-1));
          }
          var handle=url.substr(url.lastIndexOf("/")+1);
          return handle;
      };
  
  
  		SCPB.ObjectLength = function( object ) {
            var length = 0;
            for( var key in object ) {
                if( object.hasOwnProperty(key) ) {
                    ++length;
                }
            }
            return length;
        };
  
  
  
  
  search_result = function(result){
				
          SCPB.productListShopify = {};
				//
				//console.log(result.TotalProduct);
          		//console.log(result.Items);
          		scjQuery.each(result.products, function(i, product){
						SCPB.productListShopify[product.handle] = product
				});
				
          		//console.log(result.Items);	
          		//console.log('........................');
          		//console.log(SCPB.imgElements);
          		for(var handle in SCPB.imgElements){
						var imgElement = SCPB.imgElements[handle];
						var img = scjQuery("img", imgElement);
						var imgParent = img.parents(":not(a)").first();
						imgParent.addClass("sc-badge-main");
						img.before("<div class=\"sc-badge-container sc-badge-collection\">");
						objElement = scjQuery(imgElement);
						scjQuery('.sc-badge-collection', imgParent).css({
								"width" : objElement.width(),
								"height" : objElement.height(),
								"margin-left" : SCPB.getBadgeMarginW(objElement),
								"margin-right" : SCPB.getBadgeMarginW(objElement),
								"margin-top" : SCPB.getBadgeMarginH(objElement),
								"margin-bottom" : SCPB.getBadgeMarginH(objElement),
								"padding" : SCPB.getBadgePadding(objElement),
						});
						var product = SCPB.productListShopify[handle];
                  		if(product != undefined){
                  			SCPB.activeVariant = product.variants[0];
							SCPB.showBadgeForProduct(product, imgElement);
                        }
						
				}
		};
		//
		SCPB.getVariantId = function(){
				var variantId = false;
				if(typeof Shopify == "object" && typeof Shopify.urlParam == "function")
						variantId = Shopify.urlParam("variant");
				var index = typeof product_select_index === "number" ? product_select_index : 0;
				if(!variantId){
						if(scjQuery("form[action='/cart/add'] select[name='id'] option:selected").length){
								variantId = scjQuery("form[action='/cart/add'] select[name='id'] option:selected")[index].value;
						}else{
								if(scjQuery("form[action='/cart/add'] input[name='id']").length){
										variantId = scjQuery("form[action='/cart/add'] input[name='id']")[index].value;
										console.log('v', variantId);
								}
						}

				}
				return variantId;

				
		}

		SCPB.validateBadgeConditions = function(condition, product){

				var match = true;
				var sc_log = true;
				//
				if(sc_log)console.log('validation-start');
				if(condition.on_sale == 'yes'){
						if(match){
								if(!SCPB.activeVariant.hasOwnProperty("compare_at_price") || SCPB.activeVariant.compare_at_price == null){
										match = false;
								}else{
										match = false;
										var discount_price = SCPB.activeVariant.compare_at_price - SCPB.activeVariant.price;
										if(parseFloat(condition.min_discount_amount)){
												if(discount_price >= ( parseFloat(condition.min_discount_amount) * 100 )){
														match = true;
												}
										}
										if(parseFloat(condition.min_discount_percentage)){
												if(( ( discount_price / SCPB.activeVariant.compare_at_price ) * 100 ) >= parseFloat(condition.min_discount_percentage)){
														match = true;
												}
										}
								}
						}
				}else if(condition.on_sale == 'no'){
				}
				if(!match && sc_log)console.log('on_sale');
				if(condition.new == 'yes'){
						if(condition.from_time || condition.to_time){
								if(match){
										if(condition.from_time.trim() != ""){
												if(Date.parse(parsePublishedDate(product.published_at)) < Date.parse(condition.from_time)){
														match = false
												}
										}
										if(condition.to_time.trim() != "" && match){
												if(Date.parse(parsePublishedDate(product.published_at)) > Date.parse(condition.to_time)){
														match = false
												}
										}
								}
						}
						
						if(parseInt(condition.last_days) &&
								( match && ( condition.from_time.trim() == "" && condition.to_time.trim() == "" ) )
								|| ( !match && ( condition.from_time.trim() != "" || condition.to_time.trim() != "" ) )
								){
								var till_last_days = new Date(product.published_at);
								var today = new Date();
								till_last_days.setDate(till_last_days.getDate() + parseInt(condition.last_days));
								if(till_last_days < today){
										match = false;
								}else if(!match)match = true;
						}
						
				}else if(condition.new == 'no' && match){
						if(condition.from_time || condition.to_time){
								if(match){
										if(condition.from_time.trim() != ""){
												if(Date.parse(parsePublishedDate(product.published_at)) >= Date.parse(condition.from_time)){
														match = false
												}
										}
										if(condition.to_time.trim() != "" && match){
												if(Date.parse(parsePublishedDate(product.published_at)) <= Date.parse(condition.to_time)){
														match = false
												}
										}
								}
						}
						
						if(parseInt(condition.last_days) &&
								( match && ( condition.from_time.trim() == "" && condition.to_time.trim() == "" ) )
								|| ( !match && ( condition.from_time.trim() != "" || condition.to_time.trim() != "" ) )
								){
								var till_last_days = new Date(product.published_at);
								var today = Date.now();
								till_last_days.setDate(till_last_days.getDate() + parseInt(condition.last_days));
								if(till_last_days >= today){
										match = false;
								}else if(!match)match = true;
						}
						
				}

				if(!match && sc_log)console.log('new');

				if(condition.collections && match){
						match = false;
						var cids = condition.collections.split(",");
						for(var i = 0; i < product.collections.length; i++){
								var cid = product.collections[i];
								if(scjQuery.inArray(cid + "", cids) >= 0){
										match = true;
										break
								}
						}
				}

				if(!match && sc_log)console.log('collection');

				if(condition.stock == 'avail'){
						if(match){
								match = false;
								for(var i = 0; i < product.variants.length; i++){
										var variant = product.variants[i];
										if(variant.inventory_quantity > 0 || !variant.hasOwnProperty('inventory_management')){
												match = true;
												break
										}
								}
						}
				}else if(condition.stock == 'not_avail'){
						if(match){
								for(var i = 0; i < product.variants.length; i++){
										var variant = product.variants[i];
										if(variant.inventory_quantity > 0 || !variant.hasOwnProperty('inventory_management')){
												match = false;
												break
										}
								}
						}
				}else if(condition.stock == 'low_stock'){
						if(match){
								match = false;
								//
								min_qty = condition.stock_min_qty ? parseInt(condition.stock_min_qty) : 1;
								if(min_qty && min_qty <= 0)
										min_qty = 1;
								//
								for(var i = 0; i < product.variants.length; i++){
										var variant = product.variants[i];
										if(variant.inventory_quantity > 0 && variant.inventory_quantity <= min_qty && variant.hasOwnProperty('inventory_management')){
												match = true;
												break
										}
								}
						}
				}

				if(!match && sc_log)console.log('stock');

				if(condition.hasOwnProperty('from_price') || condition.hasOwnProperty('to_price')){
						if(match){
								if(condition.hasOwnProperty('from_price') && condition.from_price != ""){
										if(SCPB.activeVariant.price < ( parseFloat(condition.from_price) * 100 )){
												match = false
										}
								}
								if(condition.hasOwnProperty('to_price') && condition.to_price != "" && match){
										if(match == true && SCPB.activeVariant.price > ( parseFloat(condition.to_price) * 100 )){
												match = false
										}
								}
						}
				}

				if(!match && sc_log)console.log('from_price - to_price: ');

				if(condition.v_option == 'ex_sel_variant'){
						if(match){
								var vids = condition.variant_list.split(",");
								if(scjQuery.inArray(SCPB.activeVariant.id + "", vids) != -1){
										match = false;
								}

						}
				}else if(condition.v_option == 'sel_variant_only' && match){
						match = false;
						var vids = condition.variant_list.split(",");
						if(scjQuery.inArray(SCPB.activeVariant.id + "", vids) != -1){
								match = true;
						}
				}
				if(!match && sc_log)console.log('V_option');
				if(sc_log)console.log('validation-end: ', match);
				return match;
		}

		SCPB.showBadge = function(product, element, badgeID, imgPosition, imgText, imgURL, badgeWidth, badgeHeight, inPX, text_styles, badge_styles){

				//
          		var badgeElm;
				if(element)
						badgeElm = scjQuery(".sc-badge-container .sc-badge-img[data-sc-badge-id='" + badgeID + "']", element);
				else
						badgeElm = scjQuery(".sc-badge-container .sc-badge-img[data-sc-badge-id='" + badgeID + "']");
				//
				if(badgeElm.length > 0){
						badgeElm.first().show()
				}else{
						var newNode = '<div data-sc-badge-id="' + badgeID + '" class="sc-badge-img ' + imgPosition + '" style="background-size: cover; background-image: url('
								+ "'" + APP_BASE_URL + imgURL + "'" + '); width: ' + ( badgeWidth ? badgeWidth : 30 ) + ( inPX == "true" ? 'px' : '%' ) + '; height: ' + ( badgeHeight ? badgeHeight : 30 )
								+ ( inPX == 'true' ? 'px' : '%' ) + ';' + badge_styles + ' ">';
						if(imgText){
								var text = imgText;
								if(text.indexOf("##SAVE_PERCENTAGE##") >= 0){
										var save_percent = 0;
										if(SCPB.activeVariant.hasOwnProperty('compare_at_price') && SCPB.activeVariant.price < SCPB.activeVariant.compare_at_price){
												save_percent = ( SCPB.activeVariant.compare_at_price - SCPB.activeVariant.price ) / SCPB.activeVariant.compare_at_price * 100;
												save_percent = Math.round(save_percent * 100) / 100;
										}
										text = text.replace('##SAVE_PERCENTAGE##', save_percent);
								}
								if(text.indexOf("##SAVE_AMOUNT##") >= 0){
										var save_amount = 0;
										if(SCPB.activeVariant.hasOwnProperty('compare_at_price') && SCPB.activeVariant.price < SCPB.activeVariant.compare_at_price){
												save_amount = ( SCPB.activeVariant.compare_at_price - SCPB.activeVariant.price ) / 100;
										}
										var save_amount_with_currency = sc_pb_money_format.replace("{{amount}}", save_amount);
										text = text.replace('##SAVE_AMOUNT##', save_amount_with_currency)
								}
								if(text.indexOf("##PRODUCT_PRICE##") >= 0){
										var price_with_currency = sc_pb_money_format.replace("{{amount}}", ( SCPB.activeVariant.price / 100 ));
										text = text.replace('##PRODUCT_PRICE##', price_with_currency)
								}
								if(text.indexOf("##NEW_DAYS##") >= 0){
										var date_difference = ( Date.parse(product.published_at) - new Date() ) / 86400000;
										text = text.replace('##NEW_DAYS##', date_difference)
								}
								if(text.indexOf("##PRODUCT_SKU##") >= 0){
										if(SCPB.activeVariant.hasOwnProperty('sku')){
												if(SCPB.activeVariant.sku != ""){
														text = text.replace('##PRODUCT_SKU##', SCPB.activeVariant.sku)
												}
										}else{
												text = "";
										}
								}
								if(text.indexOf("##PRODUCT_QUANTITY##") >= 0){
										if(SCPB.activeVariant.hasOwnProperty('inventory_quantity') && SCPB.activeVariant.hasOwnProperty('inventory_management')){
												if(SCPB.activeVariant.inventory_quantity > 0 && SCPB.activeVariant.inventory_management){
														text = text.replace('##PRODUCT_QUANTITY##', SCPB.activeVariant.inventory_quantity)
												}
										}else{
												text = "";
										}
								}
								var textStyle = text_styles;
								//
								newNode += '<span class="sc-badge-content" style="' + ( textStyle ? textStyle : '' ) + '">' + text + '</span>'
						}
						newNode += '</div>';

						if(SCPB.page == "product")
								scjQuery('.sc-badge-container').append(newNode)
						else
								scjQuery('.sc-badge-container', element).append(newNode)
				}
		};

		SCPB.showBadgeForProduct = function(product, element){
          		var matched = false;
				var arrBadges = SCPB.badges;
				for(var id in arrBadges){
						var badge = arrBadges[id];
						var condition = badge.logics;
						//
						if(matched){
								break;
						}
						// 
						matched = badge.enabled === "1" ? SCPB.validateBadgeConditions(condition, product) : false;
						if(!matched){
								continue;
						}
						//
						if(SCPB.page == "product"){
								SCPB.showBadge(product, element, badge.id, badge.product.imgOptions.position, badge.product.imgOptions.text, badge.product.imgOptions.url
										, badge.product.imgOptions.badge_width, badge.product.imgOptions.badge_height, badge.product.imgOptions.in_px, badge.product.imgOptions.text_styles, badge.product.imgOptions.badge_styles);
						}else{
								
                          	SCPB.showBadge(product, element, badge.id, badge.collection.imgOptions.position, badge.collection.imgOptions.text, badge.collection.imgOptions.url
										, badge.collection.imgOptions.badge_width, badge.collection.imgOptions.badge_height, badge.collection.imgOptions.in_px, badge.collection.imgOptions.text_styles, badge.collection.imgOptions.badge_styles);
						}
				}
				return null
		};

		function getImageLinkList(){
				if(scjQuery('.sc-pb-element').length > 0){
						var elements = scjQuery('.sc-pb-element');
				}else{
						var elements = scjQuery('a[href*="/products/"]:not(form a[href*="/products/"]):not(.related-products a[href*="/products/"])').has('img[src*="/products/"], img[src*="/no-image"]');
				}

				var arrElements = {};
				elements.each(function(index, element){
						var splits = scjQuery(element).attr('href').split('/');
						var handle = splits[splits.length - 1].split('?')[0];
						arrElements[handle] = element
				});
				return arrElements;
		}

		function getImageLinkFromProductPage(){
				if(scjQuery('.sc-pb-element').length > 0){
						var images = scjQuery('.sc-pb-element');
				}else{
						var images = scjQuery('img[src*="/products/"][src*="/cdn.shopify.com/s/files/"]').filter('[src*=".jpg"],[src*=".jpeg"],[src*=".png"]');
				}

				var maxWidth = 0;
				var mainImage;
				images.each(function(index, image){
						var currentWidth = image.width;
						if(currentWidth > maxWidth){
								maxWidth = currentWidth;
								mainImage = image
						}
				});
				return mainImage;
		}

		

		function parsePublishedDate(published_date){ // added by tawhid
				var published_date = new Date(published_date);
				var year = published_date.getFullYear();
				var month = published_date.getMonth() + 1;
				var date = published_date.getDate();
				return  month + "/" + date + "/" + year;
		}

		SCPB.getBadgeMarginW = function(elem, strCssRule){
				var bordT = elem.outerWidth() - elem.innerWidth();
				var paddT = elem.innerWidth() - elem.width();
				var margT = elem.outerWidth(true) - elem.outerWidth();
				return margT / 2
		};

		SCPB.getBadgeMarginH = function(elem, strCssRule){
				var bordT = elem.outerHeight() - elem.innerHeight();
				var paddT = elem.innerHeight() - elem.height();
				var margT = elem.outerHeight(true) - elem.outerHeight();
				return margT / 2
		};

		SCPB.getBadgePadding = function(elem, strCssRule){
				var bordT = elem.outerWidth() - elem.innerWidth();
				var paddT = elem.innerWidth() - elem.width();
				var margT = elem.outerWidth(true) - elem.outerWidth();
				return paddT
		};

		SCPB.bindBadges = function(){
				if(SCPB.page === 'product'){
						scjQuery('.sc-badge-container .sc-badge-img').hide();
						//
						var image = getImageLinkFromProductPage();
						var imgObj = scjQuery(image);
						//
						var imageParent = imgObj.parents(":not(a)").first();
						imageParent.addClass("sc-badge-main");
						if(imgObj){
								imgObj.before("<div class=\"sc-badge-container\">");
								scjQuery('.sc-badge-container').css({
										"width" : imgObj.width(),
										"height" : imgObj.height(),
										"margin-left" : SCPB.getBadgeMarginW(imgObj),
										"margin-right" : SCPB.getBadgeMarginW(imgObj),
										"margin-top" : SCPB.getBadgeMarginH(imgObj),
										"margin-bottom" : SCPB.getBadgeMarginH(imgObj),
										"padding" : SCPB.getBadgePadding(imgObj),
								});
								//
								var variant = null;
								var variantId = SCPB.getVariantId();
								if(variantId){
										var product = SCPB.product;
										for(var i = 0; i < product.variants.length; i++){
												if(variantId == product.variants[i].id){
														variant = product.variants[i];
														break;
												}
										}
								}else
										variant = SCPB.product.variants[0];
								//
								SCPB.activeVariant = variant;
								//
								if(variant != null){
										SCPB.showBadgeForProduct(product, image);
								}
						}
				}else{
						SCPB.imgElements = getImageLinkList();
						//
						var searchKeyword = "";
						for(var handle in SCPB.imgElements){
								if(searchKeyword.length > 0)
										searchKeyword += " OR ";
								searchKeyword += "handle:\"" + handle + "\""
						}
						//
						var SC_AppBaseURL = "/apps/product-badge/";
						var SC_AppScriptPath = SC_AppBaseURL + 'scripts/';
						var SC_App_Front_Path = SC_AppBaseURL + 'app-front/';
						//
						
						SCPB.get_page_products(search_result);
                  		
                  		//scjQuery.getScript('/search?q=' + searchKeyword + '&view=sc-pb-front-25052016');
				}
		};
		SCPB.page = SCPB.page.split('.')[0];
		if(scjQuery.inArray(SCPB.page, ['index', 'collection', 'product']) >= 0){
      if (typeof (Storage) !== "undefined") {
      if (sessionStorage.sc_pb_badges) {
        console.log('add badge from session');
        SCPB.badges = JSON.parse(sessionStorage.sc_pb_badges);
        SCPB.bindBadges();
      } else {
        scjQuery.ajax({
          type: 'GET',
          url: "/apps/product-badge/app-front/app-front/get_all_badges",
          dataType: 'json',
          async: false,
          success: function (data, textStatus, jqXHR) {
            if (data.type == MSG_TYPE_NOTICE) {
              sessionStorage.setItem("sc_pb_badges", data.text);
              console.log('add badge from ajax');
              SCPB.badges = JSON.parse(data.text);
              SCPB.bindBadges();
            }
          }
        });
      }

      if (sessionStorage.sc_pb_settings) {
        var settings = JSON.parse(sessionStorage.sc_pb_settings);
        console.log('add settings from session');
        scjQuery('body').append("<style>" + settings.custom_css + "</style>");
      } else {
        scjQuery.ajax({
          type: 'GET',
          url: "/apps/product-badge/app-front/app-front/get_settings",
          dataType: 'json',
          async: false,
          success: function (data, textStatus, jqXHR) {
            if (data.type == MSG_TYPE_NOTICE) {
              sessionStorage.setItem("sc_pb_settings",data.text);
              console.log('add settings from ajax');
              data = JSON.parse(data.text);
              scjQuery('body').append("<style>" + data.custom_css + "</style>");
            }
          }
        });
      }
      
    } else {
      scjQuery.ajax({
        type: 'GET',
        url: "/apps/product-badge/app-front/app-front/get_all_badges",
        dataType: 'json',
        async: false,
        success: function (data, textStatus, jqXHR) {
          if (data.type == MSG_TYPE_NOTICE) {
            SCPB.badges = JSON.parse(data.text);
            SCPB.bindBadges();
          }
        }
      });

      scjQuery.ajax({
        type: 'GET',
        url: "/apps/product-badge/app-front/app-front/get_settings",
        dataType: 'json',
        async: false,
        success: function (data, textStatus, jqXHR) {
          if (data.type == MSG_TYPE_NOTICE) {
            data = JSON.parse(data.text);
            scjQuery('body').append("<style>" + data.custom_css + "</style>");
          }
        }
      });

    }
		}
		//
		SCPB.update_variant = function(variant){
				
				SCPB.activeVariant = variant;
				scjQuery('.sc-badge-container').empty();
				var image = getImageLinkFromProductPage();
				SCPB.showBadgeForProduct(SCPB.product, image);
		}


}
